## TIPS

### 立ち回り
- ボトルネックを攻める人、エスパーで遅そうなところを攻める人、とかで分かれる
- やることなくなったらマニュアルとレギュレーション読み直す
- マニュアルにあるヒントには素直に従ってみる
- 軽率にペアプロをする

### 改善策
- 重くてどうにもならない処理は複数台で分ける
- 外部 API 呼び出しがあったらとりあえず注意
  - どれくらい時間かかるか調べる (pprof では計測できない(IO は取れないため))
  - できれば呼び出さなくて済むようにする
- CPU リソースが余るときは、使い切れるようにするための設定がある (マニュアルを読め)
- OR は UNION で書き換えることでインデックスが効きやすくできる
- 無駄な SELECT FOR UPDATE や、トランザクション、ロックなどは削る
- MySQL 5.7 だと ASC, DESC 混じりは効かない
- DB からの画像配信はやめる
- 外部コマンド呼び出しはやめる ("os/exec" に注意)
- N+1 はとりあえず潰しとく
- 大きいボトルネックは簡単な改善を積み重ねていく
  - N+1 はまずは複数回クエリを発行しているところを全取得 → app 側で処理に変えてみる
  - その後に効率よく改善する
    - IN, JOIN など
- 1対多の N+1 の解決は難しい
  - 基本は、JOIN せず全件取得 → map とかに詰め替える ([slice → map への詰め替え](https://github.com/Saza-ku/s2m/blob/main/main.go))
    - LIMIT とか ORDER BY とかでちょっと複雑なことしていると難しい。キャッシュで逃げるのも手
  - ライブラリによっては JOIN できるかも
  - IN でもできないか
- LIMIT 使えないか考える
- シャーディングできないか考える

### 困ったとき

- 設定ファイルが読み込まれない → ユーザーとパーミッションを見直す

### 聞き齧りテクニック
- LIMIT OFFSET を使ったページネーションは遅い ([参考](https://mesimasi.com/posts/backend-tuning-ca))
- ストリームの書き写しには io.Copy を使う ([参考](https://mesimasi.com/posts/isucon11-final))
- ログインせずに見れるエンドポイントはプロキシキャッシュ貼っちゃう ([参考](https://matsuu.hatenablog.com/entry/2021/08/22/141130))
